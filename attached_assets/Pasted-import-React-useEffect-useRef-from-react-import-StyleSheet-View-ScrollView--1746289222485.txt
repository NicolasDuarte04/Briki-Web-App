import React, { useEffect, useRef } from 'react';
import { 
  StyleSheet, 
  View, 
  ScrollView, 
  TouchableOpacity, 
  Platform, 
  Dimensions, 
  SafeAreaView,
  ImageBackground
} from 'react-native';
import { useFonts, Inter_400Regular, Inter_600SemiBold, Inter_700Bold } from '@expo-google-fonts/inter';
import { ThemedText } from '../../components/ThemedText';
import { router } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';
import MaskedView from '@react-native-masked-view/masked-view';
import Animated, { 
  FadeInUp, 
  FadeIn,
  useAnimatedStyle, 
  withSpring, 
  withRepeat, 
  withTiming, 
  withSequence,
  useSharedValue,
  SlideInRight
} from 'react-native-reanimated';
import { StatusBar } from 'expo-status-bar';

const { width } = Dimensions.get('window');
const AnimatedTouchable = Animated.createAnimatedComponent(TouchableOpacity);

export default function HomeScreen() {
  const [fontsLoaded] = useFonts({
    Inter_400Regular,
    Inter_600SemiBold,
    Inter_700Bold
  });

  const pulseAnim = useSharedValue(1);
  const scrollViewRef = useRef(null);

  // Testimonial paging
  const testimonials = [
    {
      text: '"Briki made it so easy to find the right travel insurance. Their customer service was excellent when we had to make changes to our policy."',
      author: 'Sarah M.',
      location: 'Colombia'
    },
    {
      text: '"When my flight was canceled in Mexico, my Briki insurance covered the hotel and new flight. The claims process was surprisingly simple!"',
      author: "Carlos R.",
      location: "Mexico"
    },
    {
      text: '"As a frequent traveler, I\'ve tried many services. Briki is by far the most user-friendly with the best rates for international coverage."',
      author: "Elena T.",
      location: "Spain"
    }
  ];

  const currentTestimonial = useSharedValue(0);
  const testimonialOpacity = useSharedValue(1);

  useEffect(() => {
    // Gentle pulse animation for CTA button
    pulseAnim.value = withRepeat(
      withSequence(
        withTiming(1.03, { duration: 1500 }),
        withTiming(1, { duration: 1500 })
      ),
      -1, // Infinite repetition
      true // Reverse
    );

    // Auto-rotate testimonials
    const intervalId = setInterval(() => {
      testimonialOpacity.value = withTiming(0, { duration: 300 }, () => {
        currentTestimonial.value = (currentTestimonial.value + 1) % testimonials.length;
        testimonialOpacity.value = withTiming(1, { duration: 300 });
      });
    }, 7000);

    return () => clearInterval(intervalId);
  }, []);

  const pulseStyle = useAnimatedStyle(() => ({
    transform: [{ scale: pulseAnim.value }]
  }));

  const testimonialStyle = useAnimatedStyle(() => {
    return {
      opacity: testimonialOpacity.value,
    };
  });

  if (!fontsLoaded) {
    return null;
  }

  const handleGetQuote = () => {
    router.push('/trip-info');
  };

  const handleTestimonialDotPress = (index) => {
    testimonialOpacity.value = withTiming(0, { duration: 300 }, () => {
      currentTestimonial.value = index;
      testimonialOpacity.value = withTiming(1, { duration: 300 });
    });
  };

  return (
    <SafeAreaView style={styles.safeArea}>
      <StatusBar style="dark" />
      <ThemedView style={styles.container}>
        {/* Subtle background gradient */}
        <LinearGradient
          colors={['rgba(75, 118, 229, 0.08)', 'rgba(248, 180, 0, 0.05)', 'rgba(255, 255, 255, 0)']}
          locations={[0, 0.5, 1]}
          style={styles.backgroundGradient}
        />

        <ScrollView 
          ref={scrollViewRef}
          style={styles.scrollView} 
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Header/Logo Section */}
          <Animated.View entering={FadeInUp.delay(100).springify()} style={styles.header}>
            <View style={styles.headerContent}>
              <ThemedText style={styles.logo}>Briki</ThemedText>
              <ThemedText style={styles.welcomeText}>Welcome back!</ThemedText>
            </View>
          </Animated.View>

          {/* Hero Section */}
          <Animated.View entering={FadeInUp.delay(200).springify()} style={styles.heroSection}>
            <ThemedText style={styles.heroTitle}>
              Travel with <ThemedText style={styles.accentText}>peace of mind</ThemedText>
            </ThemedText>
            <ThemedText style={styles.heroSubtitle}>
              Compare and choose the best travel insurance for your journey
            </ThemedText>

            <AnimatedTouchable 
              style={[styles.ctaButton, pulseStyle]}
              onPress={handleGetQuote}
              activeOpacity={0.9}
              accessibilityRole="button"
              accessibilityLabel="Get insured now"
            >
              <LinearGradient
                colors={['#4B76E5', '#3D68D8']}
                start={{ x: 0, y: 0 }}
                end={{ x: 1, y: 1 }}
                style={styles.ctaGradient}
              >
                <ThemedText style={styles.ctaButtonText}>Get Insured Now</ThemedText>
                <Ionicons name="arrow-forward" size={20} color="#FFFFFF" style={styles.ctaIcon} />
              </LinearGradient>
            </AnimatedTouchable>
          </Animated.View>

          {/* Features Highlights */}
          <Animated.View entering={FadeInUp.delay(300).springify()} style={styles.featuresSection}>
            <View style={styles.featureRow}>
              <View style={styles.featureItem}>
                <View style={styles.featureIconContainer}>
                  <Ionicons name="flash" size={20} color="#4B76E5" />
                </View>
                <ThemedText style={styles.featureText}>Instant quotes</ThemedText>
              </View>
              <View style={styles.featureItem}>
                <View style={styles.featureIconContainer}>
                  <Ionicons name="shield-checkmark" size={20} color="#4B76E5" />
                </View>
                <ThemedText style={styles.featureText}>Trusted providers</ThemedText>
              </View>
              <View style={styles.featureItem}>
                <View style={styles.featureIconContainer}>
                  <Ionicons name="cash" size={20} color="#4B76E5" />
                </View>
                <ThemedText style={styles.featureText}>Best rates</ThemedText>
              </View>
            </View>
          </Animated.View>

          {/* About Briki Section */}
          <Animated.View entering={FadeInUp.delay(350).springify()} style={styles.aboutSection}>
            <ThemedText style={styles.sectionTitle}>Why Choose Briki</ThemedText>
            <View style={styles.aboutCards}>
              <Animated.View entering={FadeInUp.delay(400)} style={styles.aboutCard}>
                <View style={styles.cardHeader}>
                  <View style={[styles.iconCircle, styles.blueIcon]}>
                    <Ionicons name="rocket" size={24} color="#FFFFFF" />
                  </View>
                  <ThemedText style={styles.cardTitle}>Our Mission</ThemedText>
                </View>
                <ThemedText style={styles.cardText}>
                  Making travel insurance simple and accessible for everyone, everywhere
                </ThemedText>
              </Animated.View>

              <Animated.View entering={FadeInUp.delay(450)} style={styles.aboutCard}>
                <View style={styles.cardHeader}>
                  <View style={[styles.iconCircle, styles.goldIcon]}>
                    <Ionicons name="flash" size={24} color="#FFFFFF" />
                  </View>
                  <ThemedText style={styles.cardTitle}>Quick & Easy</ThemedText>
                </View>
                <ThemedText style={styles.cardText}>
                  Get fully insured in minutes with our streamlined digital process
                </ThemedText>
              </Animated.View>

              <Animated.View entering={FadeInUp.delay(500)} style={styles.aboutCard}>
                <View style={styles.cardHeader}>
                  <View style={[styles.iconCircle, styles.blueIcon]}>
                    <Ionicons name="shield-checkmark" size={24} color="#FFFFFF" />
                  </View>
                  <ThemedText style={styles.cardTitle}>Trusted Providers</ThemedText>
                </View>
                <ThemedText style={styles.cardText}>
                  Partner with leading insurance companies worldwide for reliable coverage
                </ThemedText>
              </Animated.View>

              <Animated.View entering={FadeInUp.delay(550)} style={styles.aboutCard}>
                <View style={styles.cardHeader}>
                  <View style={[styles.iconCircle, styles.goldIcon]}>
                    <Ionicons name="lock-closed" size={24} color="#FFFFFF" />
                  </View>
                  <ThemedText style={styles.cardTitle}>Secure Payments</ThemedText>
                </View>
                <ThemedText style={styles.cardText}>
                  Safe and encrypted transactions guaranteed with top-tier security
                </ThemedText>
              </Animated.View>
            </View>
          </Animated.View>

          {/* Recently Viewed Section */}
          <Animated.View entering={FadeInUp.delay(600)} style={styles.recentlyViewedSection}>
            <View style={styles.sectionHeader}>
              <ThemedText style={styles.sectionTitle}>Popular Plans</ThemedText>
              <TouchableOpacity 
                style={styles.viewAllButton}
                onPress={handleGetQuote}
                accessibilityRole="button"
              >
                <ThemedText style={styles.viewAllText}>View All</ThemedText>
                <Ionicons name="chevron-forward" size={14} color="#4B76E5" />
              </TouchableOpacity>
            </View>

            <ScrollView 
              horizontal
              showsHorizontalScrollIndicator={false}
              contentContainerStyle={styles.plansScrollContent}
            >
              <Animated.View entering={SlideInRight.delay(650).springify()}>
                <TouchableOpacity 
                  style={styles.planCard} 
                  onPress={handleGetQuote}
                  activeOpacity={0.9}
                  accessibilityRole="button"
                >
                  <View style={styles.planCardTop}>
                    <ThemedText style={styles.planProvider}>AXA Assistance</ThemedText>
                    <View style={styles.planBadge}>
                      <ThemedText style={styles.planBadgeText}>Popular</ThemedText>
                    </View>
                  </View>
                  <ThemedText style={styles.planName}>Premium Coverage</ThemedText>
                  <View style={styles.planFeatures}>
                    <View style={styles.planFeatureItem}>
                      <Ionicons name="checkmark-circle" size={16} color="#34C759" />
                      <ThemedText style={styles.planFeatureText}>Medical coverage up to $100,000</ThemedText>
                    </View>
                    <View style={styles.planFeatureItem}>
                      <Ionicons name="checkmark-circle" size={16} color="#34C759" />
                      <ThemedText style={styles.planFeatureText}>COVID-19 included</ThemedText>
                    </View>
                  </View>
                  <View style={styles.planFooter}>
                    <ThemedText style={styles.planPrice}>From $145</ThemedText>
                    <ThemedText style={styles.planPriceSubtext}>per person</ThemedText>
                  </View>
                </TouchableOpacity>
              </Animated.View>

              <Animated.View entering={SlideInRight.delay(700).springify()}>
                <TouchableOpacity 
                  style={styles.planCard} 
                  onPress={handleGetQuote}
                  activeOpacity={0.9}
                  accessibilityRole="button"
                >
                  <View style={styles.planCardTop}>
                    <ThemedText style={styles.planProvider}>Assist Card</ThemedText>
                    <View style={[styles.planBadge, styles.bestValueBadge]}>
                      <ThemedText style={styles.planBadgeText}>Best Value</ThemedText>
                    </View>
                  </View>
                  <ThemedText style={styles.planName}>Standard Coverage</ThemedText>
                  <View style={styles.planFeatures}>
                    <View style={styles.planFeatureItem}>
                      <Ionicons name="checkmark-circle" size={16} color="#34C759" />
                      <ThemedText style={styles.planFeatureText}>Medical coverage up to $35,000</ThemedText>
                    </View>
                    <View style={styles.planFeatureItem}>
                      <Ionicons name="checkmark-circle" size={16} color="#34C759" />
                      <ThemedText style={styles.planFeatureText}>Trip cancellation included</ThemedText>
                    </View>
                  </View>
                  <View style={styles.planFooter}>
                    <ThemedText style={styles.planPrice}>From $95</ThemedText>
                    <ThemedText style={styles.planPriceSubtext}>per person</ThemedText>
                  </View>
                </TouchableOpacity>
              </Animated.View>

              <View style={{ width: 12 }} />
            </ScrollView>
          </Animated.View>

          {/* Testimonial Section */}
          <Animated.View entering={FadeInUp.delay(750)} style={styles.testimonialSection}>
            <ThemedText style={styles.sectionTitle}>What Our Users Say</ThemedText>

            <View style={styles.testimonialContainer}>
              <Animated.View style={[styles.testimonialCard, testimonialStyle]}>
                <Ionicons name="quotes" size={28} color="rgba(75, 118, 229, 0.2)" style={styles.quoteIcon} />
                <ThemedText style={styles.testimonialText}>
                  {testimonials[currentTestimonial.value].text}
                </ThemedText>
                <View style={styles.testimonialAuthorContainer}>
                  <View style={styles.testimonialAuthorAvatar}>
                    <ThemedText style={styles.testimonialAvatarText}>
                      {testimonials[currentTestimonial.value].author.charAt(0)}
                    </ThemedText>
                  </View>
                  <View style={styles.testimonialAuthorInfo}>
                    <ThemedText style={styles.testimonialAuthor}>
                      {testimonials[currentTestimonial.value].author}
                    </ThemedText>
                    <ThemedText style={styles.testimonialLocation}>
                      {testimonials[currentTestimonial.value].location}
                    </ThemedText>
                  </View>
                </View>
              </Animated.View>

              <View style={styles.testimonialPagination}>
                {testimonials.map((_, index) => (
                  <TouchableOpacity 
                    key={index}
                    style={[
                      styles.paginationDot,
                      currentTestimonial.value === index && styles.activePaginationDot
                    ]}
                    onPress={() => handleTestimonialDotPress(index)}
                    activeOpacity={0.7}
                    accessibilityRole="button"
                    accessibilityLabel={`View testimonial ${index + 1} of ${testimonials.length}`}
                  />
                ))}
              </View>
            </View>
          </Animated.View>

          {/* Final CTA */}
          <Animated.View entering={FadeInUp.delay(800)} style={styles.finalCtaSection}>
            <TouchableOpacity 
              style={styles.finalCtaButton} 
              onPress={handleGetQuote}
              activeOpacity={0.9}
              accessibilityRole="button"
              accessibilityLabel="Get started with your insurance quote"
            >
              <ThemedText style={styles.finalCtaText}>Find Your Perfect Coverage</ThemedText>
              <Ionicons name="arrow-forward-circle" size={24} color="#FFFFFF" style={styles.finalCtaIcon} />
            </TouchableOpacity>
          </Animated.View>

          {/* Footer Space */}
          <View style={styles.footerSpace} />
        </ScrollView>
      </ThemedView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
    position: 'relative',
  },
  backgroundGradient: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    height: 500,
    zIndex: -1,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingBottom: 40,
  },
  header: {
    paddingHorizontal: 24,
    paddingTop: Platform.OS === 'ios' ? 10 : 30,
    paddingBottom: 20,
  },
  headerContent: {
    paddingTop: 10,
  },
  logo: {
    fontSize: 38,
    fontFamily: 'Inter_700Bold',
    color: '#4B76E5',
    letterSpacing: -0.5,
  },
  welcomeText: {
    fontSize: 16,
    color: '#666666',
    marginTop: 4,
    fontFamily: 'Inter_400Regular',
  },
  heroSection: {
    paddingHorizontal: 24,
    alignItems: 'center',
    paddingTop: 20,
    paddingBottom: 40,
  },
  heroTitle: {
    fontSize: 36,
    fontFamily: 'Inter_700Bold',
    textAlign: 'center',
    marginBottom: 12,
    color: '#1A1A1A',
    lineHeight: 44,
    letterSpacing: -0.5,
  },
  accentText: {
    color: '#4B76E5',
    fontFamily: 'Inter_700Bold',
  },
  heroSubtitle: {
    fontSize: 17,
    textAlign: 'center',
    color: '#666666',
    marginBottom: 34,
    lineHeight: 26,
    fontFamily: 'Inter_400Regular',
    paddingHorizontal: 10,
  },
  ctaButton: {
    borderRadius: 16,
    shadowColor: '#4B76E5',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 12,
    elevation: 8,
    width: '100%',
    maxWidth: 320,
  },
  ctaGradient: {
    borderRadius: 16,
    paddingVertical: 18,
    paddingHorizontal: 24,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
  },
  ctaButtonText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontFamily: 'Inter_600SemiBold',
    textAlign: 'center',
  },
  ctaIcon: {
    marginLeft: 8,
  },
  featuresSection: {
    paddingHorizontal: 24,
    marginBottom: 40,
  },
  featureRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: 'rgba(75, 118, 229, 0.05)',
    borderRadius: 16,
    padding: 16,
  },
  featureItem: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  featureIconContainer: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: 'rgba(75, 118, 229, 0.1)',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 8,
  },
  featureText: {
    fontSize: 13,
    color: '#333333',
    fontFamily: 'Inter_600SemiBold',
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
    paddingHorizontal: 24,
  },
  sectionTitle: {
    fontSize: 24,
    fontFamily: 'Inter_600SemiBold',
    color: '#1A1A1A',
    letterSpacing: -0.5,
  },
  viewAllButton: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  viewAllText: {
    fontSize: 14,
    color: '#4B76E5',
    fontFamily: 'Inter_600SemiBold',
    marginRight: 4,
  },
  aboutSection: {
    marginBottom: 40,
  },
  aboutCards: {
    paddingHorizontal: 24,
    gap: 16,
  },
  aboutCard: {
    backgroundColor: '#FFFFFF',
    padding: 20,
    borderRadius: 16,
    shadowColor: '#000000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.06,
    shadowRadius: 8,
    elevation: 3,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: 'rgba(0, 0, 0, 0.05)',
  },
  cardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 12,
  },
  iconCircle: {
    width: 40,
    height: 40,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  blueIcon: {
    backgroundColor: '#4B76E5',
  },
  goldIcon: {
    backgroundColor: '#F8B400',
  },
  cardTitle: {
    fontSize: 18,
    fontFamily: 'Inter_600SemiBold',
    color: '#1A1A1A',
  },
  cardText: {
    fontSize: 15,
    color: '#666666',
    lineHeight: 22,
    fontFamily: 'Inter_400Regular',
  },
  recentlyViewedSection: {
    marginBottom: 40,
  },
  plansScrollContent: {
    paddingLeft: 24,
    paddingRight: 12,
  },
  planCard: {
    width: width * 0.75,
    maxWidth: 300,
    backgroundColor: '#FFFFFF',
    borderRadius: 16,
    padding: 20,
    marginRight: 12,
    shadowColor: '#000000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.08,
    shadowRadius: 8,
    elevation: 3,
    borderWidth: 1,
    borderColor: 'rgba(0, 0, 0, 0.05)',
  },
  planCardTop: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  planProvider: {
    fontSize: 14,
    color: '#666666',
    fontFamily: 'Inter_400Regular',
  },
  planBadge: {
    backgroundColor: 'rgba(75, 118, 229, 0.1)',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 10,
  },
  bestValueBadge: {
    backgroundColor: 'rgba(52, 199, 89, 0.1)',
  },
  planBadgeText: {
    fontSize: 10,
    color: '#4B76E5',
    fontFamily: 'Inter_600SemiBold',
  },
  planName: {
    fontSize: 18,
    fontFamily: 'Inter_600SemiBold',
    color: '#1A1A1A',
    marginBottom: 12,
  },
  planFeatures: {
    marginBottom: 16,
  },
  planFeatureItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
  },
  planFeatureText: {
    fontSize: 14,
    color: '#333333',
    marginLeft: 8,
    fontFamily: 'Inter_400Regular',
  },
  planFooter: {
    marginTop: 'auto',
  },
  planPrice: {
    fontSize: 20,
    fontFamily: 'Inter_700Bold',
    color: '#4B76E5',
  },
  planPriceSubtext: {
    fontSize: 12,
    color: '#666666',
    fontFamily: 'Inter_400Regular',
  },
  testimonialSection: {
    marginBottom: 40,
  },
  testimonialContainer: {
    paddingHorizontal: 24,
  },
  testimonialCard: {
    backgroundColor: '#FFFFFF',
    padding: 24,
    borderRadius: 20,
    shadowColor: 'rgba(75, 118, 229, 0.3)',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 16,
    elevation: 3,
    borderWidth: 1,
    borderColor: 'rgba(75, 118, 229, 0.1)',
    marginBottom: 16,
  },
  quoteIcon: {
    marginBottom: 12,
    alignSelf: 'flex-start',
  },
  testimonialText: {
    fontSize: 17,
    color: '#333333',
    lineHeight: 26,
    fontFamily: 'Inter_400Regular',
    marginBottom: 20,
  },
  testimonialAuthorContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  testimonialAuthorAvatar: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: '#4B76E5',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  testimonialAvatarText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontFamily: 'Inter_600SemiBold',
  },
  testimonialAuthorInfo: {
    flex: 1,
  },
  testimonialAuthor: {
    fontSize: 16,
    fontFamily: 'Inter_600SemiBold',
    color: '#1A1A1A',
  },
  testimonialLocation: {
    fontSize: 14,
    color: '#666666',
    fontFamily: 'Inter_400Regular',
  },
  testimonialPagination: {
    flexDirection: 'row',
    justifyContent: 'center',
    gap: 8,
  },
  paginationDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: 'rgba(75, 118, 229, 0.2)',
  },
  activePaginationDot: {
    backgroundColor: '#4B76E5',
    width: 16,
  },
  finalCtaSection: {
    paddingHorizontal: 24,
    marginBottom: 40,
  },
  finalCtaButton: {
    backgroundColor: '#4B76E5',
    borderRadius: 16,
    paddingVertical: 18,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: '#4B76E5',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 12,
    elevation: 6,
  },
  finalCtaText: {
    color: '#FFFFFF',
    fontSize: 18,
    fontFamily: 'Inter_600SemiBold',
  },
  finalCtaIcon: {
    marginLeft: 8,
  },
  footerSpace: {
    height: 40,
  }
});